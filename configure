#!/bin/bash

VERSION_PRIORITY=("5.4" "5.3" "5.2" "5.1" "luajit")

check_version() {
    local version=$1
    local executables=()

    case $version in
        5.1|5.2|5.3|5.4)
            executables=("lua${version}" "lua${version//./}")
            ;;
        luajit)
            executables=("luajit")
            ;;
        *)
            return 1
            ;;
    esac

    for exe in "${executables[@]}"; do
        if command -v "$exe" &> /dev/null; then
            echo "$exe"
            return 0
        fi
    done

    return 1
}

LUA_VERSION=""
for arg in "$@"; do
    case $arg in
        --lua-version=*)
            LUA_VERSION="${arg#*=}"
            ;;
        *)
            echo "Unknown parameter: $arg" >&2
            exit 1
            ;;
    esac
done

if [ -n "$LUA_VERSION" ]; then
    if exe=$(check_version "$LUA_VERSION"); then
        echo "$exe"
        exit 0
    else
        echo "Could not find lua executable with version: $LUA_VERSION" >&2
        exit 1
    fi
fi

for version in "${VERSION_PRIORITY[@]}"; do
    if exe=$(check_version "$version"); then
        break
    fi
done

if [ -z "$exe" ]; then
    echo "Could not find any suitable lua executable." >&2
    exit 1
fi